#ifndef XPROFILER_H
#define XPROFILER_H

#include "XTime"
#include "QString"
#include "XUnorderedMap"
#include "XVector"
#include "XBucketAllocator"
#include "QMutex"

namespace Eks
{
class EKSCORE_EXPORT ProfilerProfilingContext
  {
XProperties:
  XROProperty(ProfilerProfilingContext *, parent);
  XRORefProperty(xuint32, context);
  XROProperty(ProfilerProfilingContext *, firstChild);
  XROProperty(ProfilerProfilingContext *, nextSibling);
  XRefProperty(XTimeStatistics, timeStats);

  const char *message() const { return _message; }

  ProfilerProfilingContext *findChildContext(xuint32 context, const char *);
  const ProfilerProfilingContext *findChildContext(xuint32 context, const char *) const;

  ProfilerProfilingContext(ProfilerProfilingContext* parent, xuint32 context, const char *message);

private:
  const char *_message;
  };

class EKSCORE_EXPORT Profiler
  {
public:
  typedef ProfilerProfilingContext ProfilingContext;

  class EKSCORE_EXPORT ProfileHandle
    {
  private:
    ProfileHandle(ProfilingContext *key);
    ProfilingContext *_context;
    XTime _start;
    friend class Profiler;
    };

  class EKSCORE_EXPORT ProfileScopedBlock
    {
  public:
    ProfileScopedBlock(xuint32 component, const char *message);
    ~ProfileScopedBlock();
  private:
    ProfileHandle _handle;
    };

  static ProfileHandle start(xuint32 component, const char *mess);
  static void end(const ProfileHandle &);

  // for the current thread
  static ProfilingContext *rootContext();
  // clears all threads results.
  static void clearResults();

  static QString stringForContext(xuint32 t);
  static void setStringForContext(xuint32 t, const QString &str);

private:
  Profiler();

  friend class ProfilerProfilingContext;

  ProfilingContext *_rootContext;
  UnorderedMap<QThread *, ProfilingContext *> _currentContexts;
  FixedSizeBucketAllocator _contextAllocator;
  QHash<xuint32, QString> _contextStrings;
  QMutex _lock;
  };

#ifdef X_PROFILING_ENABLED
  #define XProfileFunctionBase(component) Eks::Profiler::ProfileScopedBlock functionBlock(component, xCurrentFunction);
  #define XProfileScopedBlockBase(component, mess) Eks::Profiler::ProfileScopedBlock scopeBlock##__LINE__(component, mess);
#else
  #define XProfileFunctionBase(component)
  #define XProfileScopedBlockBase(component, mess)
#endif

}

#endif // XPROFILER_H

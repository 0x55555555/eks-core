#ifndef XALLOCATORBASE_H
#define XALLOCATORBASE_H

#include "XGlobal"
#include "XAssert"
#include "XResourceDescription"

namespace Eks
{

class AllocatorBase
  {
public:
  virtual ~AllocatorBase() {}
  virtual void *alloc(xsize size, xsize alignment=1) = 0;
  virtual void free(void *mem) = 0;

  void *alloc(const ResourceDescription &fmt)
    {
    return alloc(fmt.size(), fmt.alignment());
    }

  // todo, variadic template args here...
  template <typename T> T *create(xsize alignment=AlignmentOf<T>::Alignment)
    {
    void *d = alloc(sizeof(T), alignment);
    return new(d) T();
    }

  template <typename T, typename A> T *create(A a)
    {
    void *mem = alloc(sizeof(T), AlignmentOf<T>::Alignment);
    return new(mem) T(a);
    }

  template <typename T,
            typename A,
            typename B,
            typename C> T *create(A a, B b, C c)
    {
    void *mem = alloc(sizeof(T), AlignmentOf<T>::Alignment);
    return new(mem) T(a, b, c);
    }

  template <typename T,
            typename A,
            typename B,
            typename C,
            typename D> T *create(A a, B b, C c, D d)
    {
    void *mem = alloc(sizeof(T), AlignmentOf<T>::Alignment);
    return new(mem) T(a, b, c, d);
    }


  template <typename T, typename A> T *createWithAlignment(A a, xsize alignment)
    {
    void *mem = alloc(sizeof(T), alignment);
    return new(mem) T(a);
    }

  template <typename T,
            typename A,
            typename B,
            typename C> T *createWithAlignment(A a, B b, C c, xsize alignment)
    {
    void *mem = alloc(sizeof(T), alignment);
    return new(mem) T(a, b, c);
    }

  template <typename T,
            typename A,
            typename B,
            typename C,
            typename D> T *createWithAlignment(A a, B b, C c, D d, xsize alignment)
    {
    void *mem = alloc(sizeof(T), alignment);
    return new(mem) T(a, b, c, d);
    }

  template <typename T> void destroy(T *t)
    {
    (void)t;
    t->~T();
    free(t);
    }
  };

}

#endif // XALLOCATORBASE_H
